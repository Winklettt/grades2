name: Grades Watcher

on:
  workflow_dispatch: {}
  schedule:
    # Cron in UTC â€” hier z.B. alle 15 Minuten. Passe an.
    - cron: '*/15 * * * *'

permissions:
  contents: write   # damit das Action den previous.json commit/push kann

jobs:
  check-grades:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run grades watcher
        env:
          # Login & target URLs (anpassen!)
          LOGIN_URL: ${{ secrets.LOGIN_URL }}
          GRADES_URL: ${{ secrets.GRADES_URL }}

          # Option 1: Form login
          LOGIN_FORM_FIELD_USER: ${{ secrets.LOGIN_FORM_FIELD_USER }}   # optional
          LOGIN_FORM_FIELD_PASS: ${{ secrets.LOGIN_FORM_FIELD_PASS }}   # optional
          LOGIN_USERNAME: ${{ secrets.LOGIN_USERNAME }}
          LOGIN_PASSWORD: ${{ secrets.LOGIN_PASSWORD }}

          # Option 2: JSON payload (falls API login)
          # LOGIN_PAYLOAD_JSON: ${{ secrets.LOGIN_PAYLOAD_JSON }}

          # SMTP (zum Versenden der Mail)
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}

          # Git commit info (optional)
          GIT_COMMIT_NAME: "grades-bot"
          GIT_COMMIT_EMAIL: "action@users.noreply.github.com"

          # GitHub token (Actions liefert automatisch)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python main.py
